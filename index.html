<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TrÆ°á»ng Äáº¡i Há»c Kinh Táº¿ Ká»¹ Thuáº­t - CÃ´ng Nghiá»‡p â€” Dashboard</title>

  <!-- TailwindCSS -->s
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' };</script>

  <!-- Lucide icons -->
  <script type="module" src="https://unpkg.com/lucide@0.234.0/dist/lucide.esm.js"></script>
  <script nomodule src="https://unpkg.com/lucide@0.234.0/dist/lucide.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root { --bg1:#12121a; --bg2:#1b2733; }
    body { background:linear-gradient(180deg,var(--bg1),var(--bg2)); }
    .sidebar {
      background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      backdrop-filter:blur(6px); border-right:1px solid rgba(255,255,255,0.03);
    }
    .stat-card {
      background:linear-gradient(135deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.04); transition:transform .3s, box-shadow .3s;
      cursor:pointer;
    }
    .stat-card:hover { transform:translateY(-6px) scale(1.02); box-shadow:0 12px 30px rgba(2,6,23,0.6); }
    .title-gradient {
      display:inline-block;
      background:linear-gradient(90deg,#00d2ff,#3a7bd5,#7f00ff);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      background-clip:text; color:transparent; font-weight:800;
    }
    .ribbon { height:8px; border-radius:6px; box-shadow:0 6px 20px rgba(0,0,0,0.5) inset; }
  </style>
</head>
<body class="text-slate-200 min-h-screen font-sans">
  <div class="flex">
    <!-- Sidebar -->
    <aside class="sidebar w-20 lg:w-56 min-h-screen p-4 flex flex-col gap-6">
      <div class="flex items-center space-x-3 mb-6">
        <img src="https://img.freepik.com/premium-vector/pixel-art-illustration-earth-globe-pixelated-earth-globe-earth-globe-icon-pixelated-pixel_1038602-458.jpg"
             alt="Logo TrÃ¡i Äáº¥t" class="w-12 h-12 rounded-xl object-cover shadow-lg ring-2 ring-blue-400"/>
        <div>
          <p class="text-sm text-gray-400">Tráº¡m</p>
          <h1 class="text-lg font-semibold text-white">Äo MÃ´i trÆ°á»ng</h1>
        </div>
      </div>

      <div class="bg-white/5 rounded-xl p-4 text-sm text-slate-300 shadow-inner border border-white/10 space-y-2">
        <div class="flex justify-between"><span class="text-gray-400">ğŸ“ Äá»‹a Ä‘iá»ƒm:</span><span class="font-semibold text-blue-300">P.LÄ©nh Nam</span></div>
        <div class="flex justify-between"><span class="text-gray-400">ğŸŸ¢ Tráº¡ng thÃ¡i:</span><span class="font-semibold text-green-400">Äang hoáº¡t Ä‘á»™ng</span></div>
        <div class="flex justify-between"><span class="text-gray-400">ğŸ•’ Cáº­p nháº­t:</span><span class="font-semibold text-yellow-300">1 giÃ¢y/láº§n</span></div>
        <div class="flex justify-between"><span class="text-gray-400">ğŸ”— Káº¿t ná»‘i:</span><span class="font-semibold text-cyan-300">LoRa / Blynk IoT</span></div>
      </div>

      <div class="flex-1"></div>
      <button onclick="clearHistory()" class="text-xs text-red-400 hover:text-red-300">ğŸ—‘ï¸ XÃ³a lá»‹ch sá»­</button>
      <div class="hidden lg:block text-slate-500 text-xs">Â© 2025 â€¢ Demo</div>
    </aside>

    <!-- Main -->
    <div class="flex-1 p-6 lg:p-10">
      <div class="mb-8">
        <h1 class="text-3xl font-extrabold"><span class="title-gradient">TrÆ°á»ng Äáº¡i Há»c Kinh Táº¿ Ká»¹ Thuáº­t VÃ  CÃ´ng Nghiá»‡p HÃ  Ná»™i</span></h1>
        <div class="text-slate-400 text-sm mt-1">GiÃ¡m sÃ¡t thá»i gian thá»±c â€¢ Dá»¯ liá»‡u tá»« Blynk</div>
      </div>

      <!-- Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="stat-card p-4 rounded-2xl" onclick="openDetail('temperature')">
          <div class="ribbon" style="background:linear-gradient(90deg,#ff9a9e,#ff6b6b);"></div>
          <div class="mt-3"><div class="text-slate-400 text-sm">Nhiá»‡t Ä‘á»™</div><div id="temperature-val" class="text-2xl font-bold mt-1">-- Â°C</div></div>
        </div>
        <div class="stat-card p-4 rounded-2xl" onclick="openDetail('humidity')">
          <div class="ribbon" style="background:linear-gradient(90deg,#1dd1a1,#00b894);"></div>
          <div class="mt-3"><div class="text-slate-400 text-sm">Äá»™ áº©m</div><div id="humidity-val" class="text-2xl font-bold mt-1">-- %</div></div>
        </div>
        <div class="stat-card p-4 rounded-2xl" onclick="openDetail('pm')">
          <div class="ribbon" style="background:linear-gradient(90deg,#845ec2,#5f27cd);"></div>
          <div class="mt-3"><div class="text-slate-400 text-sm">Äá»™ bá»¥i (PM2.5)</div><div id="pm-val" class="text-2xl font-bold mt-1">-- Âµg/mÂ³</div></div>
        </div>
        <div class="stat-card p-4 rounded-2xl" onclick="openDetail('voltage')">
          <div class="ribbon" style="background:linear-gradient(90deg,#ffd86f,#f9c74f);"></div>
          <div class="mt-3"><div class="text-slate-400 text-sm">Äiá»‡n Ã¡p</div><div id="voltage-val" class="text-2xl font-bold mt-1">-- V</div></div>
        </div>
      </div>

      <!-- Chart -->
      <div class="bg-[#0b1320] rounded-2xl p-5 stat-card max-w-[1200px] mx-auto">
        <div class="flex items-center justify-between mb-4">
          <div><div class="text-sm text-slate-400">Xu hÆ°á»›ng</div><div class="text-lg font-semibold">Táº¥t cáº£ thÃ´ng sá»‘ theo thá»i gian</div></div>
          <div class="text-xs text-slate-400">Cáº­p nháº­t: <span id="lastUpdate">--</span></div>
        </div>
        <canvas id="mainChart" height="120"></canvas>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="detailPanel" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/60" onclick="closeDetail()"></div>
    <div class="relative max-w-3xl w-full mx-auto bg-[#08121a] p-6 rounded-2xl stat-card">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h3 id="detailTitle" class="text-xl font-bold">Chi tiáº¿t</h3>
          <div class="text-slate-400 text-sm">Lá»‹ch sá»­ cáº­p nháº­t</div>
        </div>
        <div class="flex gap-2">
          <button id="unitBtn" onclick="toggleUnit()" class="px-3 py-1 bg-blue-600 rounded-md">Äá»•i Ä‘Æ¡n vá»‹</button>
          <button onclick="closeDetail()" class="px-3 py-1 bg-red-600 rounded-md">ÄÃ³ng</button>
        </div>
      </div>
      <canvas id="detailChart" height="200"></canvas>
      <ul id="detailList" class="mt-4 text-sm max-h-52 overflow-auto space-y-2 text-slate-300"></ul>
    </div>
  </div>

  <script>
    const BLYNK_TOKEN = "U5_wkAX9W8JnXjTHjMzerLFuh9KavAAF";
    const INTERVAL_MS = 300000;

    // --- Load history tá»« localStorage ---
    const history = JSON.parse(localStorage.getItem("historyData") ||
      '{"temperature":[],"humidity":[],"pm":[],"voltage":[]}');

    let mainChart, detailChart, activeKey = null, unitMode = {}; // unitMode[key] = 'alt'

    function pushHistory(k, v, t = Date.now()) {
      history[k].push({ t, v });
      if (history[k].length > 1000) history[k].shift(); // lÆ°u tá»‘i Ä‘a 1000 Ä‘iá»ƒm
    }

    const getLast = k => history[k].length ? history[k][history[k].length - 1].v : 0;

    async function fetchBlynkData() {
      try {
        const res = await fetch(`https://blynk.cloud/external/api/get?token=${BLYNK_TOKEN}&V0&V1&V2&V3`);
        const data = await res.json();
        const temp = +data.V0 || 0, hum = +data.V1 || 0, pm = +data.V2 || 0, volt = +data.V3 || 0;
        const now = Date.now();
        pushHistory("temperature", temp, now);
        pushHistory("humidity", hum, now);
        pushHistory("pm", pm, now);
        pushHistory("voltage", volt, now);
        localStorage.setItem("historyData", JSON.stringify(history)); // ğŸ’¾ LÆ°u láº¡i

        document.getElementById("temperature-val").innerText = temp + " Â°C";
        document.getElementById("humidity-val").innerText = hum + " %";
        document.getElementById("pm-val").innerText = pm + " Âµg/mÂ³";
        document.getElementById("voltage-val").innerText = volt + " V";
        document.getElementById("lastUpdate").innerText = new Date(now).toLocaleTimeString();
        updateMainChart();
        if (activeKey) updateDetailChart(activeKey);
      } catch (e) { console.error("Lá»—i khi Ä‘á»c dá»¯ liá»‡u:", e); }
    }

    function createMainChart() {
      const ctx = document.getElementById('mainChart').getContext('2d');
      mainChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            { label: 'Nhiá»‡t Ä‘á»™', borderColor: '#ff6b6b', backgroundColor: 'rgba(255,107,107,0.08)', data: [] },
            { label: 'Äá»™ áº©m', borderColor: '#1dd1a1', backgroundColor: 'rgba(29,209,161,0.08)', data: [] },
            { label: 'PM2.5', borderColor: '#845ec2', backgroundColor: 'rgba(132,94,194,0.08)', data: [] },
            { label: 'Äiá»‡n Ã¡p', borderColor: '#ffd86f', backgroundColor: 'rgba(255,216,111,0.08)', data: [] }
          ]
        },
        options: { responsive: true, plugins: { legend: { labels: { color: '#94a3b8' } } },
          scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } } }
      });
    }

    function updateMainChart() {
      const labels = history.temperature.map(p => new Date(p.t).toLocaleTimeString());
      mainChart.data.labels = labels;
      mainChart.data.datasets[0].data = history.temperature.map(p => p.v);
      mainChart.data.datasets[1].data = history.humidity.map(p => p.v);
      mainChart.data.datasets[2].data = history.pm.map(p => p.v);
      mainChart.data.datasets[3].data = history.voltage.map(p => p.v);
      mainChart.update();
    }

    // --- Modal ---
    function openDetail(key) {
      activeKey = key;
      document.getElementById('detailPanel').classList.remove('hidden');
      document.getElementById('detailPanel').classList.add('flex');
      document.getElementById('detailTitle').innerText = {
        temperature: 'Nhiá»‡t Ä‘á»™',
        humidity: 'Äá»™ áº©m',
        pm: 'Äá»™ bá»¥i (PM2.5)',
        voltage: 'Äiá»‡n Ã¡p'
      }[key];
      createDetailChart(key);
    }

    function closeDetail() {
      activeKey = null;
      document.getElementById('detailPanel').classList.add('hidden');
      document.getElementById('detailPanel').classList.remove('flex');
      if (detailChart) detailChart.destroy();
    }

    // --- Äá»•i Ä‘Æ¡n vá»‹ ---
    function toggleUnit() {
      if (!activeKey) return;
      unitMode[activeKey] = !unitMode[activeKey];
      updateDetailChart(activeKey);
    }

    function convertValue(key, v) {
      if (!unitMode[key]) return v;
      switch (key) {
        case 'temperature': return (v * 9/5 + 32).toFixed(1); // Â°F
        case 'pm': return Math.round(v * 2); // Ä‘Æ¡n giáº£n: Âµg/mÂ³ *2 = AQI xáº¥p xá»‰
        case 'voltage': return (v * 1000).toFixed(0); // mV
        default: return v;
      }
    }

    function getUnitLabel(key) {
      if (!unitMode[key]) return {temperature:"Â°C",humidity:"%",pm:"Âµg/mÂ³",voltage:"V"}[key];
      return {temperature:"Â°F",humidity:"%",pm:"AQI",voltage:"mV"}[key];
    }

    function createDetailChart(key) {
      const ctx = document.getElementById('detailChart').getContext('2d');
      if (detailChart) detailChart.destroy();
      detailChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: history[key].map(p => new Date(p.t).toLocaleTimeString()),
          datasets: [{
            label: key,
            data: history[key].map(p => convertValue(key, p.v)),
            borderColor: '#00d2ff',
            backgroundColor: 'rgba(0,210,255,0.1)'
          }]
        },
        options: { plugins: { legend: { display: false } },
          scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } } }
      });
      updateDetailList(key);
    }

    function updateDetailChart(key) {
      if (!detailChart) return;
      detailChart.data.labels = history[key].map(p => new Date(p.t).toLocaleTimeString());
      detailChart.data.datasets[0].data = history[key].map(p => convertValue(key, p.v));
      detailChart.update();
      updateDetailList(key);
    }

    function updateDetailList(key) {
      const ul = document.getElementById('detailList');
      ul.innerHTML = '';
      [...history[key]].slice(-20).reverse().forEach(it => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${new Date(it.t).toLocaleTimeString()}</span> <strong>${convertValue(key,it.v)} ${getUnitLabel(key)}</strong>`;
        ul.appendChild(li);
      });
    }

    function clearHistory() {
      localStorage.removeItem("historyData");
      Object.keys(history).forEach(k => history[k] = []);
      if (mainChart) updateMainChart();
      alert("ğŸ—‘ï¸ ÄÃ£ xÃ³a toÃ n bá»™ lá»‹ch sá»­ lÆ°u cá»¥c bá»™!");
    }

    createMainChart();
    updateMainChart(); // load dá»¯ liá»‡u cÅ©
    fetchBlynkData();
    setInterval(fetchBlynkData, INTERVAL_MS);
  </script>
</body>
</html>
