<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tr·∫°m ƒëo m√¥i tr∆∞·ªùng th√¥ng minh ‚Äî Dashboard</title>

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' };</script>

  <!-- Lucide icons -->
  <script type="module" src="https://unpkg.com/lucide@0.234.0/dist/lucide.esm.js"></script>
  <script nomodule src="https://unpkg.com/lucide@0.234.0/dist/lucide.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* Core colors */
    :root {
      --bg1: #12121a;
      --bg2: #1b2733;
    }
    body {
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    /* Sidebar */
    .sidebar {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      backdrop-filter: blur(6px);
      border-right: 1px solid rgba(255,255,255,0.03);
    }

    /* Cards */
    .stat-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.04);
      transition: transform .3s, box-shadow .3s;
    }
    .stat-card:hover {
      transform: translateY(-6px) scale(1.01);
      box-shadow: 0 12px 30px rgba(2,6,23,0.6);
    }

    /* Logo image styling */
    .logo-img {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }

    /* Title gradient */
    .title-gradient {
      display: inline-block;
      background: linear-gradient(90deg,#00d2ff,#3a7bd5,#7f00ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      color: transparent;
      font-weight: 800;
    }

    /* Additional styling */
    .ribbon {
      height: 8px;
      border-radius: 6px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.5) inset;
    }
  </style>
</head>
<body class="text-slate-200 min-h-screen font-sans">
  <div class="flex">
    <!-- Sidebar -->
        <!-- Sidebar -->
    <aside class="sidebar w-20 lg:w-56 min-h-screen p-4 flex flex-col gap-6">
      <!-- Logo -->
      <div class="flex items-center space-x-3 mb-6">
        <img 
          src="https://img.freepik.com/premium-vector/pixel-art-illustration-earth-globe-pixelated-earth-globe-earth-globe-icon-pixelated-pixel_1038602-458.jpg" 
          alt="Logo Tr√°i ƒê·∫•t"
          class="w-12 h-12 rounded-xl object-cover shadow-lg ring-2 ring-blue-400"
        />
        <div>
          <p class="text-sm text-gray-400">Tr·∫°m</p>
          <h1 class="text-lg font-semibold text-white">M√¥i Tr∆∞·ªùng</h1>
        </div>
      </div>

      <!-- Th√¥ng tin tr·∫°m -->
      <div class="bg-white/5 rounded-xl p-4 text-sm text-slate-300 shadow-inner border border-white/10 space-y-2">
        <div class="flex justify-between items-center">
          <span class="text-gray-400">üìç ƒê·ªãa ƒëi·ªÉm:</span>
          <span class="font-semibold text-blue-300">TP. H·ªì Ch√≠ Minh</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-gray-400">üü¢ Tr·∫°ng th√°i:</span>
          <span class="font-semibold text-green-400">ƒêang ho·∫°t ƒë·ªông</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-gray-400">üïí C·∫≠p nh·∫≠t:</span>
          <span class="font-semibold text-yellow-300">5 ph√∫t/l·∫ßn</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-gray-400">üîó K·∫øt n·ªëi:</span>
          <span class="font-semibold text-cyan-300">LoRa / Blynk IoT</span>
        </div>
      </div>

      <div class="flex-1"></div>
      <div class="hidden lg:block text-slate-500 text-xs">¬© 2025 ‚Ä¢ Demo</div>
    </aside>


    <!-- Main content -->
    <div class="flex-1 p-6 lg:p-10">
      <!-- Topbar (title only) -->
      <div class="flex items-center justify-between mb-8">
        <div>
          <h1 class="text-3xl font-extrabold"><span class="title-gradient">Tr·∫°m ƒëo m√¥i tr∆∞·ªùng th√¥ng minh</span></h1>
          <div class="text-slate-400 text-sm mt-1">Gi√°m s√°t th·ªùi gian th·ª±c ‚Ä¢ D·ªØ li·ªáu gi·∫£ l·∫≠p (m·∫∑c ƒë·ªãnh)</div>
        </div>
      </div>

      <!-- Stat cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Nhi·ªát ƒë·ªô -->
        <div class="stat-card p-4 rounded-2xl cursor-pointer" onclick="openDetail('temperature')">
          <div class="ribbon" style="background: linear-gradient(90deg,#ff9a9e,#ff6b6b);"></div>
          <div class="mt-3 flex justify-between items-center">
            <div>
              <div class="text-slate-400 text-sm">Nhi·ªát ƒë·ªô</div>
              <div id="temperature-val" class="text-2xl font-bold mt-1">-- ¬∞C</div>
            </div>
            <div class="flex flex-col items-end">
              <svg data-lucide="thermometer" class="w-8 h-8 text-red-400"></svg>
              <div class="text-xs text-slate-400">C·∫£m bi·∫øn: DHT</div>
            </div>
          </div>
        </div>

        <!-- ƒê·ªô ·∫©m -->
        <div class="stat-card p-4 rounded-2xl cursor-pointer" onclick="openDetail('humidity')">
          <div class="ribbon" style="background: linear-gradient(90deg,#1dd1a1,#00b894);"></div>
          <div class="mt-3 flex justify-between items-center">
            <div>
              <div class="text-slate-400 text-sm">ƒê·ªô ·∫©m</div>
              <div id="humidity-val" class="text-2xl font-bold mt-1">-- %</div>
            </div>
            <div class="flex flex-col items-end">
              <svg data-lucide="droplet" class="w-8 h-8 text-sky-400"></svg>
              <div class="text-xs text-slate-400">C·∫£m bi·∫øn: DHT</div>
            </div>
          </div>
        </div>

        <!-- ƒê·ªô b·ª•i -->
        <div class="stat-card p-4 rounded-2xl cursor-pointer" onclick="openDetail('pm')">
          <div class="ribbon" style="background: linear-gradient(90deg,#845ec2,#5f27cd);"></div>
          <div class="mt-3 flex justify-between items-center">
            <div>
              <div class="text-slate-400 text-sm">ƒê·ªô b·ª•i (PM2.5)</div>
              <div id="pm-val" class="text-2xl font-bold mt-1">-- ¬µg/m¬≥</div>
            </div>
            <div class="flex flex-col items-end">
              <svg data-lucide="cloud" class="w-8 h-8 text-amber-300"></svg>
              <div class="text-xs text-slate-400">C·∫£m bi·∫øn: PMS5003</div>
            </div>
          </div>
        </div>

        <!-- ƒêi·ªán √°p -->
        <div class="stat-card p-4 rounded-2xl cursor-pointer" onclick="openDetail('voltage')">
          <div class="ribbon" style="background: linear-gradient(90deg,#ffd86f,#f9c74f);"></div>
          <div class="mt-3 flex justify-between items-center">
            <div>
              <div class="text-slate-400 text-sm">ƒêi·ªán √°p</div>
              <div id="voltage-val" class="text-2xl font-bold mt-1">-- V</div>
            </div>
            <div class="flex flex-col items-end">
              <svg data-lucide="battery-charging" class="w-8 h-8 text-lime-300"></svg>
              <div class="text-xs text-slate-400">Ngu·ªìn: pin</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts layout -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main multi-line chart -->
        <div class="lg:col-span-2 bg-[#0b1320] rounded-2xl p-5 stat-card">
          <div class="flex items-center justify-between mb-4">
            <div>
              <div class="text-sm text-slate-400">Xu h∆∞·ªõng</div>
              <div class="text-lg font-semibold">T·∫•t c·∫£ th√¥ng s·ªë theo th·ªùi gian</div>
            </div>
            <div class="text-xs text-slate-400">C·∫≠p nh·∫≠t: <span id="lastUpdate">--</span></div>
          </div>
          <canvas id="mainChart" height="140"></canvas>
        </div>

        <!-- Small bar chart -->
        <div class="bg-[#0b1320] rounded-2xl p-4 stat-card">
          <div class="mb-3">
            <div class="text-sm text-slate-400">S·ªë li·ªáu hi·ªán t·∫°i</div>
            <div class="text-xs text-slate-400">ƒê∆°n v·ªã: ¬∞C / % / ¬µg/m¬≥ / V</div>
          </div>
          <canvas id="barChart" height="120"></canvas>
        </div>

        <!-- Small pie chart -->
        <div class="bg-[#0b1320] rounded-2xl p-4 stat-card">
          <div class="mb-3">
            <div class="text-sm text-slate-400">T·ª∑ l·ªá tr·∫°ng th√°i</div>
            <div class="text-xs text-slate-400">B√¨nh th∆∞·ªùng / C·∫£nh b√°o</div>
          </div>
          <canvas id="pieChart" height="120"></canvas>
        </div>
      </div>

      <footer class="mt-8 text-slate-500 text-sm">Demo gi·∫£ l·∫≠p ‚Ä¢ C·∫≠p nh·∫≠t m·ªói <span id="intervalText">5 ph√∫t</span></footer>

    </div>
  </div>

  <!-- Detail Modal -->
  <div id="detailPanel" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/60" onclick="closeDetail()"></div>
    <div class="relative max-w-4xl w-full p-6 rounded-2xl bg-[#08121a] stat-card">
      <div class="flex items-start justify-between mb-4">
        <div>
          <h3 id="detailTitle" class="text-xl font-bold">Chi ti·∫øt</h3>
          <div id="detailSubtitle" class="text-sm text-slate-400">L·ªãch s·ª≠ c·∫≠p nh·∫≠t</div>
        </div>
        <div class="flex items-center gap-3">
          <button class="px-3 py-2 bg-white/5 rounded-md" onclick="exportCSV()">Xu·∫•t CSV</button>
          <button class="px-3 py-2 bg-red-600 rounded-md" onclick="closeDetail()">ƒê√≥ng</button>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <canvas id="detailChart" height="220"></canvas>
        </div>
        <div>
          <div class="text-slate-400">Gi√° tr·ªã hi·ªán t·∫°i:</div>
          <div id="detailCurrent" class="text-3xl font-bold mt-2">--</div>
          <div class="mt-4 text-slate-400 text-sm">L·ªãch s·ª≠ g·∫ßn nh·∫•t:</div>
          <ul id="detailList" class="mt-2 text-sm max-h-52 overflow-auto space-y-2 text-slate-300"></ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const FAST_MODE = false; // ƒë·∫∑t true ƒë·ªÉ test nhanh (5s)
    const INTERVAL_MS = FAST_MODE ? 5000 : 300000; // 5s ho·∫∑c 5 ph√∫t
    document.getElementById('intervalText').innerText = FAST_MODE ? '5 gi√¢y' : '5 ph√∫t';

    // History storage
    const MAX_POINTS = 300;
    const history = {
      temperature: [],
      humidity: [],
      pm: [],
      voltage: []
    };

    function pushHistory(key, value, ts = Date.now()) {
      history[key].push({ t: ts, v: value });
      if (history[key].length > MAX_POINTS) history[key].shift();
    }

    function simulateData() {
      const now = Date.now();
      const temp = +(18 + Math.random()*12).toFixed(1);
      const hum  = +(35 + Math.random()*50).toFixed(0);
      const pm   = +(5 + Math.random()*120).toFixed(0);
      const volt = +(3.3 + Math.random()*1.5).toFixed(2);

      pushHistory('temperature', temp, now);
      pushHistory('humidity', hum, now);
      pushHistory('pm', pm, now);
      pushHistory('voltage', volt, now);

      document.getElementById('temperature-val').innerText = temp + ' ¬∞C';
      document.getElementById('humidity-val').innerText = hum + ' %';
      document.getElementById('pm-val').innerText = pm + ' ¬µg/m¬≥';
      document.getElementById('voltage-val').innerText = volt + ' V';
      document.getElementById('lastUpdate').innerText = new Date(now).toLocaleTimeString();

      updateMainChart();
      updateSmallCharts();
      if (window.activeKey) updateDetailChart(window.activeKey);
    }

    // Initial seed data
    (function seed() {
      const now = Date.now();
      for (let i = 30; i > 0; i--) {
        const ts = now - i * (FAST_MODE ? 5000 : 300000);
        pushHistory('temperature', +(18 + Math.random()*12).toFixed(1), ts);
        pushHistory('humidity', +(35 + Math.random()*50).toFixed(0), ts);
        pushHistory('pm', +(5 + Math.random()*120).toFixed(0), ts);
        pushHistory('voltage', +(3.3 + Math.random()*1.5).toFixed(2), ts);
      }
    })();

    // Chart variables
    let mainChart = null, barChart = null, pieChart = null, detailChart = null;

    function createCharts() {
      const mainCtx = document.getElementById('mainChart').getContext('2d');
      mainChart = new Chart(mainCtx, {
        type: 'line',
        data: {
          labels: history.temperature.map(p => new Date(p.t).toLocaleTimeString()),
          datasets: [
            { label:'Nhi·ªát ƒë·ªô', data:history.temperature.map(p=>p.v), borderColor:'#ff6b6b', backgroundColor:'rgba(255,107,107,0.08)', tension:0.35, fill:true, pointRadius:2 },
            { label:'ƒê·ªô ·∫©m', data:history.humidity.map(p=>p.v), borderColor:'#1dd1a1', backgroundColor:'rgba(29,209,161,0.08)', tension:0.35, fill:true, pointRadius:2 },
            { label:'PM2.5', data:history.pm.map(p=>p.v), borderColor:'#845ec2', backgroundColor:'rgba(132,94,194,0.08)', tension:0.35, fill:true, pointRadius:2 },
            { label:'ƒêi·ªán √°p', data:history.voltage.map(p=>p.v), borderColor:'#ffd86f', backgroundColor:'rgba(255,216,111,0.08)', tension:0.35, fill:true, pointRadius:2 }
          ]
        },
        options: {
          responsive:true,
          plugins:{ legend:{ position:'top', labels:{ color:'#94a3b8'} } },
          scales: {
            x:{ ticks:{ color:'#94a3b8' } },
            y:{ ticks:{ color:'#94a3b8' } }
          }
        }
      });

      const barCtx = document.getElementById('barChart').getContext('2d');
      barChart = new Chart(barCtx, {
        type:'bar',
        data:{
          labels:['Nhi·ªát ƒë·ªô','ƒê·ªô ·∫©m','PM2.5','ƒêi·ªán √°p'],
          datasets:[{ data:[getLast('temperature'), getLast('humidity'), getLast('pm'), getLast('voltage')], backgroundColor:['#ff9a9e','#1dd1a1','#845ec2','#ffd86f'] }]
        },
        options:{
          indexAxis:'y',
          responsive:true,
          plugins:{ legend:{ display:false } },
          scales:{ y:{ ticks:{ color:'#94a3b8' } }, x:{ display:false } }
        }
      });

      const pieCtx = document.getElementById('pieChart').getContext('2d');
      pieChart = new Chart(pieCtx, {
        type:'doughnut',
        data:{
          labels:['B√¨nh th∆∞·ªùng','C·∫£nh b√°o'],
          datasets:[{ data:[75,25], backgroundColor:['#00d2ff','#ff6b6b'] }]
        },
        options:{
          responsive:true,
          plugins:{ legend:{ position:'bottom', labels:{ color:'#94a3b8' } } }
        }
      });
    }

    function updateMainChart(){
      mainChart.data.labels = history.temperature.map(p=>new Date(p.t).toLocaleTimeString());
      mainChart.data.datasets.forEach(ds => {
        ds.data = history[ds.label === 'Nhi·ªát ƒë·ªô' ? 'temperature' : ds.label === 'ƒê·ªô ·∫©m' ? 'humidity' : ds.label === 'PM2.5' ? 'pm' : 'voltage'].map(p=>p.v);
      });
      mainChart.update();
    }

    function updateSmallCharts(){
      barChart.data.datasets[0].data = [getLast('temperature'), getLast('humidity'), getLast('pm'), getLast('voltage')];
      barChart.update();

      const pmVal = getLast('pm');
      const warnPercent = Math.min(100, Math.round((pmVal / 150) * 100));
      pieChart.data.datasets[0].data = [100 - warnPercent, warnPercent];
      pieChart.update();
    }

    function openDetail(key){
      window.activeKey = key;
      document.getElementById('detailPanel').classList.remove('hidden');
      document.getElementById('detailTitle').innerText = {
        temperature:'Nhi·ªát ƒë·ªô',
        humidity:'ƒê·ªô ·∫©m',
        pm:'ƒê·ªô b·ª•i',
        voltage:'ƒêi·ªán √°p'
      }[key] + ' ‚Ä¢ Chi ti·∫øt';
      createDetailChart(key);
      populateDetailList(key);
    }

    function closeDetail(){
      window.activeKey = null;
      document.getElementById('detailPanel').classList.add('hidden');
      if(detailChart){ detailChart.destroy(); detailChart = null; }
    }

    function createDetailChart(key){
      const ctx = document.getElementById('detailChart').getContext('2d');
      if(detailChart) detailChart.destroy();
      detailChart = new Chart(ctx, {
        type:'line',
        data:{
          labels: history[key].map(p=>new Date(p.t).toLocaleString()),
          datasets:[{ label:key, data: history[key].map(p=>p.v), borderColor:'#00d2ff', backgroundColor:'rgba(0,210,255,0.08)', tension:0.35, fill:true, pointRadius:2 }]
        },
        options:{
          responsive:true,
          plugins:{ legend:{ display:false } },
          scales:{ x:{ ticks:{ color:'#94a3b8' } }, y:{ ticks:{ color:'#94a3b8' } } }
        }
      });
      document.getElementById('detailCurrent').innerText = history[key].length ? history[key][history[key].length-1].v : '--';
    }

    function updateDetailChart(key){
      if(!detailChart) return;
      detailChart.data.labels = history[key].map(p=>new Date(p.t).toLocaleString());
      detailChart.data.datasets[0].data = history[key].map(p=>p.v);
      detailChart.update();
      document.getElementById('detailCurrent').innerText = history[key].length ? history[key][history[key].length-1].v : '--';
      populateDetailList(key);
    }

    function populateDetailList(key){
      const ul = document.getElementById('detailList');
      ul.innerHTML = '';
      const arr = history[key].slice().reverse().slice(0,30);
      arr.forEach(it => {
        const li = document.createElement('li');
        li.className = 'flex justify-between text-slate-300';
        li.innerHTML = `<span>${new Date(it.t).toLocaleString()}</span><strong class="font-mono">${it.v}</strong>`;
        ul.appendChild(li);
      });
    }

    function getLast(key){
      const arr = history[key];
      return arr.length ? arr[arr.length - 1].v : 0;
    }

    function exportCSV(){
      if(!window.activeKey) return alert('M·ªü chi ti·∫øt m·ªôt th√¥ng s·ªë tr∆∞·ªõc khi xu·∫•t CSV.');
      const arr = history[window.activeKey];
      let csv = 'timestamp,value\n';
      arr.forEach(r => csv += `${new Date(r.t).toISOString()},${r.v}\n`);
      const blob = new Blob([csv], { type:'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${window.activeKey}_history.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Start
    createCharts();
    simulateData();
    setInterval(simulateData, INTERVAL_MS);

    window.addEventListener('keydown', e => {
      if(e.key === 'Escape') closeDetail();
    });
  </script>
</body>
</html>
